# Handover Document - Combat Prototype

**Date:** 2025-11-12
**Status:** Button redesign complete, React patterns documented, user learning React/TypeScript workflow
**For:** Next AI agent continuing development

---

## üéØ What You're Inheriting

A **working tactical CRPG combat prototype** with a **complete HP-based damage system** and **50ms atomic tick intervals**. The core engine runs, skills are data-driven from CSV files, and the UI shows both fighters' actions side-by-side with redesigned action buttons featuring hover tooltips.

**Recent Major Changes (Nov 11-12, 2025):**

- ‚úÖ Action buttons redesigned with larger icons, improved layout, and hover tooltips
- ‚úÖ All modals converted to React Portals to fix z-index layering issues
- ‚úÖ Counter speed bonus mechanics implemented (deflection/parry)
- ‚úÖ Defense prediction UI implemented (parry line selection, deflection attack prediction)
- ‚úÖ Feint system implemented with attack morphing
- ‚úÖ User documentation created for navigating React+Tailwind codebase
- ‚úÖ Emergency defense repositioning and wait button fixes

**Tech Stack:**

- React + TypeScript + Vite (hot reload works)
- Tailwind CSS v3.4.17 ‚ö†Ô∏è (LOCKED - v4 causes issues, never upgrade)
- Node.js build scripts (CommonJS)
- 100% browser-based, no backend

**Run it:**

```bash
cd combat-prototype
npm run dev          # Start dev server at http://localhost:5173/
npm run build:skills # Rebuild all skills from CSV
npm run validate:skills # Check CSV without writing files
```

---

## üìÇ Project Structure

```
MyRPG/
‚îú‚îÄ‚îÄ .claude/                            # Claude Code settings
‚îÇ   ‚îú‚îÄ‚îÄ commands/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handover.md                 # This handover command
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ onboard.md                  # Onboarding command
‚îÇ   ‚îî‚îÄ‚îÄ settings.local.json             # Local Claude settings
‚îÇ
‚îú‚îÄ‚îÄ .vscode/
‚îÇ   ‚îî‚îÄ‚îÄ settings.json                   # VSCode settings
‚îÇ
‚îú‚îÄ‚îÄ Backlog-Later/                      # Future features
‚îÇ   ‚îú‚îÄ‚îÄ Player_Character_Sheet.md
‚îÇ   ‚îî‚îÄ‚îÄ Resource System.md
‚îÇ
‚îú‚îÄ‚îÄ combat-prototype/                   # **MAIN COMBAT PROTOTYPE**
‚îÇ   ‚îú‚îÄ‚îÄ dist/                           # Build output (generated)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CombatSkills/               # Copied from public/
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ telegraphs/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ README.md           # Asset management guide
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CombatSkills/               # **Skill data (CSV + JSON)**
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ README.md               # **START HERE** - CSV workflow guide
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ attacks/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ CombatSkills-attack.csv     # **Source of truth for attacks**
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ diagonal_slash.json         # Generated
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ overhead_strike.json        # Generated
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ side_slash.json             # Generated
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ thrust.json                 # Generated
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ upward_strike.json          # Generated
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ defense/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ CombatSkills-defense.csv    # **Source of truth for defenses**
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ CombatSkills-defense.md     # Defense skill designs
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ deflection.json             # Generated
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ emergency_defense.json      # Generated
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ parry.json                  # Generated
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ retreat.json                # Generated
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ special/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ CombatSkills-special.csv    # **Source of truth for specials**
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ feint.json                  # Generated
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ combos/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ slash_slash_thrust.json     # Combo example (not implemented)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ buildSkills.cjs             # **CSV‚ÜíJSON build system** (~580 lines, heavily commented)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Actions/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ActionPanel.tsx     # **Action buttons** (skill buttons with tooltips)
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LineSelectionModal.tsx      # Parry line selection (React Portal)
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AttackPredictionDropdown.tsx # Deflection attack prediction (React Portal)
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FeintSelectionModal.tsx     # Feint attack selection (React Portal)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Timeline/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TimelinePanel.tsx   # 5 synchronized timebars
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CombatScene.tsx         # **Main container** (3-column layout)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ViewModeSelector.tsx    # View mode toggle
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ engine/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ GameEngine.ts           # **CORE** - Combat logic, atomic tick loop (~811 lines)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CombatTypes.ts          # **START HERE** - ALL type definitions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ App.tsx                     # React app entry
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.tsx                    # Vite entry
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ package.json                    # Dependencies
‚îÇ   ‚îú‚îÄ‚îÄ package-lock.json
‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json                   # TypeScript config
‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.app.json
‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.node.json
‚îÇ   ‚îú‚îÄ‚îÄ vite.config.ts                  # Vite config
‚îÇ   ‚îî‚îÄ‚îÄ README.md                       # Combat prototype readme
‚îÇ
‚îú‚îÄ‚îÄ extra_context/                      # Historical docs & user guides
‚îÇ   ‚îú‚îÄ‚îÄ 20251108_handover.md            # Earlier handover
‚îÇ   ‚îú‚îÄ‚îÄ answers.md
‚îÇ   ‚îú‚îÄ‚îÄ Combat3 - TechStack.md
‚îÇ   ‚îú‚îÄ‚îÄ Combat3 - TechStack -considerations.md
‚îÇ   ‚îú‚îÄ‚îÄ how to change buttons.md        # **USER GUIDE** - Finding React components
‚îÇ   ‚îú‚îÄ‚îÄ SETUP_GUIDE.md
‚îÇ   ‚îî‚îÄ‚îÄ TechStack_Recommendation.md
‚îÇ
‚îú‚îÄ‚îÄ 20251110_handover.md                # Previous handover
‚îú‚îÄ‚îÄ 20251110_defensive_skills_implementation.md  # Defense implementation notes
‚îú‚îÄ‚îÄ 20251111_1_handover.md              # Yesterday's handover
‚îú‚îÄ‚îÄ 20251112_1_handover.md              # **THIS FILE**
‚îú‚îÄ‚îÄ Atomic_Turns.md                     # Early atomic turn design
‚îú‚îÄ‚îÄ Claude_Summary.md                   # Project vision & design analysis
‚îú‚îÄ‚îÄ CODE_GUIDE.md                       # How the codebase works
‚îú‚îÄ‚îÄ Combat3 - atomic_turns.md           # **ESSENTIAL** - Phase system, atomic turns
‚îú‚îÄ‚îÄ CombatSkillData-DesignDoc.md        # Skill data design
‚îú‚îÄ‚îÄ Timelines-design.md                 # Timeline visualization design
‚îú‚îÄ‚îÄ PRD.md                              # **ESSENTIAL** - Resource system, damage rules
‚îú‚îÄ‚îÄ CLAUDE.md                           # **ESSENTIAL** - User instructions for AI agents
‚îú‚îÄ‚îÄ package.json                        # Root dependencies
‚îî‚îÄ‚îÄ package-lock.json
```

---

## üìö Reading List (Read in Order)

### Essential Reading (Start Here):

1. **[CLAUDE.md](CLAUDE.md)** - User instructions and working agreements
   - How to work with this user (skeptical, research-focused)
   - React best practices (avoid unnecessary useEffect)
   - User is learning TypeScript, coming from HTML/CSS background

2. **[Combat3 - atomic_turns.md](Combat3 - atomic_turns.md)** - The combat phase system
   - 50ms atomic tick system
   - Phase progression (windUp ‚Üí committed ‚Üí impact ‚Üí recovery for attacks)
   - Phase progression (windUp ‚Üí active ‚Üí recovery for defenses)
   - Telegraph mechanics
   - Defense timing windows

3. **[PRD.md](PRD.md)** - Product requirements document
   - HP-based damage system (lines 182-203)
   - Resource system (4-layer design)
   - Combat skills definitions
   - Current implementation status

4. **[combat-prototype/src/types/CombatTypes.ts](combat-prototype/src/types/CombatTypes.ts)** - ALL type definitions
   - FighterState, ActionState, GameState
   - CombatSkill structure
   - Phase types
   - Defense properties

5. **[combat-prototype/src/engine/GameEngine.ts](combat-prototype/src/engine/GameEngine.ts)** - Core combat logic
   - Atomic tick loop (runs every 50ms when started)
   - Phase progression for attacks and defenses
   - Impact resolution with damage formula
   - Defense active window checking
   - executeSkill() with delayed tick start
   - Counter speed bonus mechanics

6. **[combat-prototype/public/CombatSkills/README.md](combat-prototype/public/CombatSkills/README.md)** - CSV workflow guide
   - How to edit skills via CSV
   - Build system workflow
   - Auto-calculated fields

### User Documentation (NEW - Nov 12):

7. **[extra_context/how to change buttons.md](extra_context/how to change buttons.md)** - **USER-CREATED GUIDE**
   - How to find React components in the codebase
   - Search patterns for template functions
   - Tailwind CSS class reference
   - Button styling locations
   - **IMPORTANT:** User created this to navigate React+Tailwind codebase

### Recent Changes & Context:

8. **[20251111_1_handover.md](20251111_1_handover.md)** - Previous handover document
   - HP-based damage system details
   - CSV build system details
   - UI layout (3-column)
   - Defense skill structure
   - Past issues solved

9. **[20251110_defensive_skills_implementation.md](20251110_defensive_skills_implementation.md)** - Defense implementation notes
   - Parry line selection UI
   - Deflection attack prediction
   - Emergency defense damage model
   - Retreat movement mechanics

10. **[CODE_GUIDE.md](CODE_GUIDE.md)** - How the codebase works
    - Architecture patterns
    - File organization
    - Key functions

### Secondary Reading (Reference):

11. **[Claude_Summary.md](Claude_Summary.md)** - Project vision & design analysis
    - Grimdark tactical CRPG
    - No RNG philosophy
    - Character system
    - Resource cascade

12. **[combat-prototype/scripts/buildSkills.cjs](combat-prototype/scripts/buildSkills.cjs)** - CSV‚ÜíJSON build system
    - Heavily commented (~580 lines)
    - Auto-calculation logic
    - Validation rules
    - Asset checking

13. **[combat-prototype/public/CombatSkills/defense/CombatSkills-defense.md](combat-prototype/public/CombatSkills/defense/CombatSkills-defense.md)** - Defense skill designs
    - Defense mechanics by type
    - Timing windows
    - Counter mechanics

---

## ‚ö° Critical Context Not in Docs

### 1. **User is Learning React/TypeScript** (NEW - Nov 12)

**IMPORTANT:** The user comes from an HTML/CSS background and is learning React + TypeScript + Tailwind.

**User's Background:**
- "I am used to html and css"
- Finds React+Tailwind approach less readable than traditional HTML/CSS
- Struggles with finding where styling is defined in React components
- Appreciates clear explanations with file paths and line numbers

**How to Help This User:**
- ‚úÖ Always provide file paths with line numbers: `ActionPanel.tsx:145`
- ‚úÖ Explain TypeScript types clearly
- ‚úÖ Show examples from actual codebase
- ‚úÖ Explain WHY React patterns are used, not just WHAT they are
- ‚úÖ Offer multiple approaches (CSS modules, better comments, constants)
- ‚úÖ Be patient with questions about React patterns

**Example from conversation:**
> User: "How do you know that line 150 is about this button? Why is Feint not covered by this button in line 150? I am used to html and css. why is this approach better. For me the readability is aweful. I get the benefits of inline styling but still can;t edit something I can;t find."

**My response included:**
- Explanation of template functions vs inline definitions
- Comparison of HTML/CSS vs React+Tailwind
- Trade-offs (consistency vs discoverability)
- Multiple solution options

**User then created their own documentation file** to remember the pattern!

### 2. **React+Tailwind Navigation Pattern** (NEW - Nov 12)

**How to Find Component Styling in This Codebase:**

When you see a button like:
```typescript
{renderSkillButton('side_slash', '‚û°Ô∏è', 'bg-blue-600 hover:bg-blue-700')}
```

Search for:
```typescript
const renderSkillButton =
// OR
function renderSkillButton
```

**Pattern Recognition Table:**

| What you see | What to search for | Where it takes you |
|--------------|-------------------|-------------------|
| `{renderSkillButton('side_slash', ...)}` | `const renderSkillButton =` | Line 75 - function definition with all styling |
| `<LineSelectionModal isOpen={...} />` | `function LineSelectionModal` or `export function LineSelectionModal` | The component file with its styling |
| `<button className="..." />` | Just look at that line | Styling is right there inline |

**This is documented in:** `extra_context/how to change buttons.md`

### 3. **Action Buttons Redesigned** (NEW - Nov 11)

**Recent redesign features:**
- Larger icons (text-3xl = 30px)
- Improved layout with flexbox
- Hover tooltips showing skill details
- Color-coded timing phases
- ms‚Üíseconds conversion in tooltips
- Emergency defense button repositioned

**Location:** [ActionPanel.tsx:75-189](combat-prototype/src/components/Actions/ActionPanel.tsx)

**renderSkillButton Template Function:**
```typescript
const renderSkillButton = (skillId: string, icon: string, colorClass: string, onClick?: () => void) => {
  // Template creates 8+ skill buttons with:
  // - Large left-aligned icon (text-3xl)
  // - Skill name and timing info
  // - Stamina cost display
  // - Hover tooltip with detailed stats
  // - Color-coded phases in tooltip
}
```

**Styling is inline in the template:**
- Line 145: Button container (`px-3 py-1` padding, `gap-3` spacing)
- Line 153: Icon size (`text-3xl`)
- Lines 158-164: Text container alignment and margins

**Special buttons NOT using template:**
- Wait button: Lines 199-220
- Feint button: Lines 225-259

**Why?** They have special behavior and conditional enabling logic.

### 4. **React Portal Pattern for Modals** (NEW - Nov 11)

**ALL modals MUST use React Portals to avoid z-index layering issues.**

**Pattern (ALWAYS use this):**
```typescript
import { createPortal } from 'react-dom';

export function MyModal({ isOpen, onClose }: Props) {
  if (!isOpen) return null;

  const modalContent = (
    <div
      className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]"
      onClick={onClose}
    >
      <div
        className="bg-gray-800 rounded-lg p-6 max-w-md w-full"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Modal content */}
      </div>
    </div>
  );

  return createPortal(modalContent, document.body);
}
```

**Why React Portals?**
- Escapes parent component stacking contexts
- Ensures modal appears above ALL UI elements regardless of z-index
- Prevents z-index layering issues with sticky/relative positioned parents

**Standard pattern used in:**
- `LineSelectionModal.tsx` - Parry line selection
- `AttackPredictionDropdown.tsx` - Deflection attack prediction
- `FeintSelectionModal.tsx` - Feint attack selection

**Previous Issue (FIXED):**
User reported: "in predict attack modal. I still see some issues with layering, is it a portal? The sholuders, body is from Telegraph stages card is going over the predict attack modal."

**Solution:** Converted all modals to React Portals.

### 5. **Counter Speed Bonus Implementation** (NEW - Nov 11)

**How windUp modifier works with immutable skill data:**

The skill phases are loaded from JSON and remain immutable. Counter speed bonuses are applied via modifier pattern:

**Step 1: Store bonus on FighterState after successful defense**
```typescript
// In resolveImpact() after successful parry/deflection (GameEngine.ts)
if (defenseProps?.counterSpeedBonus) {
  defender.activeCounterBonus = defenseProps.counterSpeedBonus; // 100ms or 300ms
  this.log(`${defender.name} gains ${defenseProps.counterSpeedBonus}ms counter bonus!`);
}
```

**Step 2: Apply bonus as negative modifier in executeSkill()**
```typescript
let windUpModifier = 0;
if (fighter.activeCounterBonus && skill.type === "attack") {
  windUpModifier = -fighter.activeCounterBonus; // Negative = faster
  this.log(`${fighter.name} uses ${fighter.activeCounterBonus}ms counter bonus`);
  fighter.activeCounterBonus = undefined; // Clear after use
}

fighter.currentAction = {
  // ... other fields
  windUpModifier, // -100 or -300
};
```

**Step 3: Apply modifier in phase calculations**
```typescript
// In updatePhaseProgression() for attacks
const windUpEnd = skill.phases.windUp.duration + (action.windUpModifier || 0);
const impactTick = skill.phases.impact.tick + (action.windUpModifier || 0);
// Example: 500ms windUp + (-300ms modifier) = 200ms actual windUp
```

**Result:** Deflection with 300ms counter bonus reduces next attack windUp from 500ms ‚Üí 200ms, massive riposte advantage!

**Key Design Decision:** Bonus is cleared on ANY new action, encouraging immediate counter-attacks.

### 6. **Defense Prediction UI Implemented** (NEW - Nov 11)

**Parry Line Selection:**
- Modal shows 5 line options (high, horizontal, center, low, diagonal)
- User must predict opponent's attack line
- Wrong prediction = parry fails
- Location: `LineSelectionModal.tsx`

**Deflection Attack Prediction:**
- Dropdown shows opponent's available attacks
- User must predict specific attack
- Wrong prediction = deflection fails
- Location: `AttackPredictionDropdown.tsx`

**Both use React Portals for proper layering!**

### 7. **Feint System Implemented** (NEW - Nov 11)

**How feint works:**
1. Player starts an attack (windUp phase begins)
2. Opponent telegraphs a defense
3. Player clicks "Feint" during windUp phase
4. Modal shows available attacks to morph into
5. New attack starts with 100ms time penalty + 1.4x stamina cost

**Location:** `FeintSelectionModal.tsx`

**Feint properties (from CSV):**
- `timePenalty`: 100ms
- `staminaCostMultiplier`: 1.4

### 8. **HP-Based Damage System** (Implemented Nov 10)

**All references to "clean hit" and "hitsRemaining" have been removed.**

**Current System:**
- Both PC and NPC: **3 HP**
- All attacks: **3 base damage**
- Death condition: **HP <= 0**

**Damage Formula:**
```typescript
finalDamage = attackDamage * (1 - damageReductionPercent) - damageReductionFlat;
if (finalDamage < 0) finalDamage = 0;
```

**Defense Damage Reduction:**
- Emergency Defense: 2 flat reduction ‚Üí 1 damage taken (3 - 2 = 1)
- Retreat: 100% reduction ‚Üí 0 damage (full dodge)
- Parry: 3 flat reduction ‚Üí 0 damage (3 - 3 = 0)
- Deflection: 3 flat reduction ‚Üí 0 damage (3 - 3 = 0)

**Implementation:** `GameEngine.ts:441-497` (resolveImpact method)

### 9. **50ms Tick Interval** (Changed from 100ms)

**Atomic tick is now 50ms**, not 100ms.

**Why changed:**
- Better timing precision
- Thrust attack (850ms impact) was being skipped with 100ms ticks
- All skill impact ticks must be multiples of 50ms

**Validation:**
```typescript
// GameEngine.ts:185-189
if (impactTick % this.tickInterval !== 0) {
  throw new Error(
    `Invalid skill "${skill.id}": impact tick (${impactTick}) must be a multiple of tick interval (${this.tickInterval}ms)`
  );
}
```

**IMPORTANT:** Old comments referencing "100ms" may be outdated. Current system uses **50ms ticks**.

### 10. **Delayed Tick Interval Start** (Implemented Nov 10)

**Combat timer doesn't start until first action is taken.**

**How it works:**
1. `GameEngine.start()` sets `isRunning = true` but doesn't start the interval
2. Game is in "ready" state, waiting for first action
3. When either PC or NPC calls `executeSkill()`, the 50ms tick interval starts
4. Combat timing begins immediately when first action is taken

**Implementation:**
- `ticksStarted` flag added (GameEngine.ts:41)
- `start()` modified to not start interval (lines 202-216)
- `executeSkill()` starts interval on first action (lines 686-696)
- `stop()` resets `ticksStarted = false` (line 226)

### 11. **Impact Uses TICK Approach, Not Duration**

**Tick is better** for this atomic system.

**JSON format:**
```json
{
  "windUp": { "duration": 400 },
  "committed": { "duration": 800 },
  "impact": { "tick": 1200 }, // ‚Üê Absolute time, NOT duration
  "recovery": { "duration": 800 }
}
```

**Why tick won:**
- Clearer tactical communication: "Attack hits at 1200ms"
- Impact is instant event, not sustained phase
- Telegraphs use absolute times already
- Easier for designers to balance

**Build script validation:** Fails if `impact_tick ‚â† windUp + committed`

### 12. **CSV Build System is the Data Management Layer**

**All combat skills come from CSV files.** JSON files are generated artifacts.

**Workflow:**
1. Edit CSV file (skills as columns for easy comparison)
2. Run `npm run build:skills`
3. Build script generates JSON with auto-calculated values
4. Game engine loads JSON at runtime

**Why CSV as columns:**
```csv
id,overhead_strike,side_slash,thrust
name,Overhead Strike,Horizontal Strike,Thrust
windUp_duration,400,500,250
```

- Easy visual comparison across all skills
- Fast bulk editing in text editor (VSCode)
- Git diff shows what changed

**Build script features:**
- Auto-calculates `impact_tick = windUp + committed`
- Auto-generates `type`, `school`, `stage` numbers
- Dynamically detects telegraph stages (t1, t2, ..., t99+, no limit!)
- Checks for missing assets (warns but doesn't fail)
- Validates timing values (errors on mismatch)
- Validates impact tick alignment with 50ms interval
- Supports attacks, defenses, AND special skills

**File:** `scripts/buildSkills.cjs` (heavily commented, ~580 lines)

### 13. **Defense Skills Have Active Windows, Not Committed Phase**

**Defense structure differs from attacks.**

**Phases:**
- `windUp` - Preparing defense
- `active` - Defense is ready, auto-triggers on impact (NOT committed!)
- `recovery` - Resetting to guard

**CSV format:**
```csv
windUp_duration,100,200,300,300
active_duration,200,400,500,500  # NOT committed_duration!
recovery_duration,500,300,200,200
```

**Defense properties:**
```csv
requiresLine,false,false,true,false
requiresAttackId,false,false,false,true
defenseType,emergency,movement,deflection,deflection
damageReductionPercent,0,1.0,0,0
damageReductionFlat,2,0,3,3
```

### 14. **Fighter Names**

**PC:** "Mizhael"
**NPC:** "Bandit"

Changed in the constructor:
```typescript
// GameEngine.ts:66-67
this.pc = this.createFighter("pc", "Mizhael");
this.npc = this.createFighter("npc", "Bandit");
```

### 15. **Both Fighters Manually Controlled (For Now)**

**No AI yet.** User simulates both fighters to test mechanics.

PC actions on left, NPC actions on right. This is intentional for prototyping.

### 16. **UI Layout is 3-Column**

**Changed from stacked layout to side-by-side.**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PC Actions  ‚îÇ  Center Content  ‚îÇ NPC Actions ‚îÇ
‚îÇ  (left)     ‚îÇ  (Timeline, Log) ‚îÇ  (right)    ‚îÇ
‚îÇ  w-64       ‚îÇ    flex-1        ‚îÇ  w-64       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**ActionPanel.tsx** accepts `fighter` prop:
```typescript
<ActionPanel fighter="pc" ... />
<ActionPanel fighter="npc" ... />
```

**Tailwind warning:** Don't use template literals for dynamic classes!

```typescript
// WRONG - purged at build time
className={`text-${color}-400`}

// RIGHT - conditional expressions
className={fighter === 'pc' ? 'text-green-400' : 'text-red-400'}
```

---

## üèóÔ∏è Architecture Patterns

### CSV Build System Flow:

```
CSV Files (source of truth)
  ‚Üì npm run build:skills
buildSkills.cjs
  ‚Üì parseCSV()
  ‚Üì detectTelegraphStages()
  ‚Üì buildAttackSkill() / buildDefenseSkill() / buildSpecialSkill()
  ‚Üì validateSkill()
  ‚Üì checkAssets()
JSON Files (generated)
  ‚Üì fetch at runtime
GameEngine.loadSkills()
```

### Event-Driven Game Loop:

```
GameEngine (pure TypeScript, no React)
  ‚Üì emits events every tick
React Components
  ‚Üì re-render
UI updates
```

**Key insight:** Engine has zero React dependencies. UI is just a listener.

### Atomic Tick Loop:

```typescript
// GameEngine.ts:246-270
private tick(): void {
  if (this.pauseState.isPaused) return;

  this.currentTick += this.tickInterval; // Advance time by 50ms

  this.updateFighter(this.pc);
  this.updateFighter(this.npc);

  this.emitStateUpdate(); // ‚Üí React
}
```

**Tick interval only starts when first action is taken!**

Everything happens in 50ms increments. Deterministic, no RNG.

### Phase Progression:

```typescript
// Attack: windUp ‚Üí committed ‚Üí impact ‚Üí recovery
if (elapsed < windUpEnd) ‚Üí windUp
else if (elapsed < impactTick) ‚Üí committed
else if (elapsed === impactTick) ‚Üí impact (ONE tick only!)
else if (elapsed < recoveryEnd) ‚Üí recovery
else ‚Üí action complete, clear it

// Defense: windUp ‚Üí active ‚Üí recovery
if (elapsed < windUpEnd) ‚Üí windUp
else if (elapsed < activeEnd) ‚Üí active
else if (elapsed < recoveryEnd) ‚Üí recovery
else ‚Üí action complete, clear it
```

Impact resolves **once** when entering impact phase (using prevPhase check).

---

## üîß Current Skill Inventory

### ‚úÖ Implemented Skills (10 total):

**Attacks (5):**
1. `overhead_strike` - Vertical overhead, high line, 400ms windUp, 2000ms total
2. `side_slash` - Horizontal slash, horizontal line, 500ms windUp, 2100ms total
3. `thrust` - Forward stab, center line, 250ms windUp, 1550ms total (fastest)
4. `upward_strike` - Rising attack, low line, 400ms windUp, 2000ms total
5. `diagonal_slash` - Angled cut, diagonal line, 600ms windUp, 2500ms total (slowest)

**Defenses (4):**
1. `emergency_defense` - Last resort, 100ms windUp, 2 flat reduction, 500ms recovery
2. `retreat` - Movement, 200ms windUp, 100% reduction (full dodge), 300ms recovery
3. `parry` - Line-based block, 300ms windUp, 3 flat reduction, requires correct line, 200ms recovery
4. `deflection` - Attack prediction block, 300ms windUp, 3 flat reduction, requires attack ID, 200ms recovery

**Special (1):**
1. `feint` - Attack morph, reads defender telegraph, 100ms penalty, 1.4x stamina cost

**All attacks deal 3 base damage. All skills have 4-stage telegraphs.**

### üìä Skill Balance (50ms tick system):

**Fastest attack:** thrust (250ms windUp, 850ms impact, 1550ms total)
**Slowest attack:** diagonal_slash (600ms windUp, 1900ms impact, 2500ms total)
**Fastest defense:** emergency_defense (100ms windUp = very late reaction)
**Shortest recovery:** parry & deflection (200ms = riposte opportunity)

---

## üêõ Past Issues Solved (Don't Repeat)

1. **Tailwind CSS v4 incompatibility** - Locked to v3.4.17, never upgrade
2. **Duration vs Tick for impact** - Tick won
3. **Thrust not doing damage** - Fixed by changing tick interval from 100ms to 50ms
4. **Impact timing precision** - Added validation: impact_tick % tickInterval === 0
5. **Legacy clean hit system** - Completely removed from all files
6. **hitsRemaining field** - Removed from FighterState interface
7. **Dynamic class names in Tailwind** - Use conditionals, NOT template literals
8. **Timeline bars shrinking** - Fixed with overlaid text
9. **Duplicate JSON files** - Old capitalized names removed
10. **Modal z-index layering issues** - Fixed by converting all modals to React Portals (Nov 11)
11. **Emergency defense title wrapping** - Fixed text alignment (Nov 11)
12. **Feint cost display wrapping** - Fixed text alignment (Nov 11)

---

## üìã Known Limitations & Next Steps

### ‚ö†Ô∏è Current Limitations:

- **No asset files** - All telegraphs use placeholder.png
- **Manual fighter control** - No NPC AI yet
- **No visual telegraphs** - Only combat log messages
- **No combo system** - Each skill is independent

### üéØ Likely Next Requests:

**High Priority:**
1. Add visual telegraph indicators (images/animations)
2. Create actual telegraph assets (replace placeholders)
3. NPC AI decision tree
4. More attack/defense skills

**Medium Priority:**
5. Combo system (skill chaining)
6. Counter attack system refinement
7. UI polish/animations
8. Sound effects

**Lower Priority:**
9. Skill unlock progression
10. Tutorial/tooltips
11. Performance optimization

**User might ask to:**
- Adjust CSV timing values and rebuild
- Add new skills via CSV
- Balance stamina costs
- Change telegraph trigger times
- Add new special skills
- Test combat mechanics
- Explain React patterns

---

## üéØ What User Cares About

### High Priority:

- **CSV workflow** - Easy skill balancing without touching code
- **Combat feel** - Timing must be clear and fair
- **HP-based damage system** - Simple, deadly, tactical
- **Telegraph system** - Reading and counter-reading telegraphs
- **No RNG** - Everything deterministic
- **Learning TypeScript** - User wants to understand how it works
- **Learning React patterns** - User is transitioning from HTML/CSS

### Less Priority (For Now):

- UI polish/animations (functional > beautiful)
- React patterns/best practices (learning gradually)
- Performance optimization
- Code organization/refactoring
- Documentation (unless requested)

**User's words:** "TypeScript is a must. I want to understand how it works. Then UI is secondary I just want it to work."

---

## üí° Working With This User

**Communication style:**
- Prefers concise, accurate explanations
- Will edit CSV/code files directly
- Likes seeing options/trade-offs before choosing
- Values technical accuracy over validation
- New to TypeScript, appreciates clear type explanations
- Coming from HTML/CSS, learning React+Tailwind patterns

**When explaining code:**
- ‚úÖ Show file path with line numbers: `GameEngine.ts:245`
- ‚úÖ Explain TypeScript types clearly
- ‚úÖ Reference design docs by name
- ‚úÖ Use examples from actual codebase
- ‚úÖ Explain WHY React patterns are used, not just WHAT
- ‚úÖ Offer multiple approaches when user finds something confusing

**Red flags (DON'T do this):**
- ‚ùå Don't create documentation files unprompted
- ‚ùå Don't refactor unless asked
- ‚ùå Don't add emojis unless requested
- ‚ùå Don't guess at URLs
- ‚ùå Don't update git without being asked
- ‚ùå Don't assume user knows React patterns

**User instructions from CLAUDE.md:**
1. Double-check things, be skeptical, do research
2. User is not always right (neither are you)
3. Stick to React best practices (avoid unnecessary effects)

**Example interaction (Nov 12):**
User asked: "How do you know that line 150 is about this button? Why is Feint not covered by this button in line 150? I am used to html and css. why is this approach better. For me the readability is aweful."

Good response included:
- Explanation of template functions
- Comparison of HTML/CSS vs React+Tailwind
- Trade-offs discussion
- Multiple solution options
- Encouragement to document their learning

**User then created their own documentation!** This shows user engagement and learning.

---

## üîç Quick Reference

### File Locations:

**Engine:** `src/engine/GameEngine.ts` (~811 lines)
**Types:** `src/types/CombatTypes.ts` (all interfaces)
**Build script:** `scripts/buildSkills.cjs` (~580 lines, heavily commented)
**React entry:** `src/components/CombatScene.tsx` (3-column layout)
**Action panel:** `src/components/Actions/ActionPanel.tsx` (accepts `fighter` prop)
**Modal components:** `src/components/Actions/LineSelectionModal.tsx`, `AttackPredictionDropdown.tsx`, `FeintSelectionModal.tsx`

### Key Functions:

**Main loop:** `GameEngine.tick()` - runs every 50ms (when started)
**Phase update:** `GameEngine.updatePhaseProgression()` - checks elapsed time
**Impact resolution:** `GameEngine.resolveImpact()` - applies damage formula
**Defense check:** `GameEngine.isDefenseActive()` - checks defense effectiveness
**Skill execution:** `GameEngine.executeSkill()` - starts tick interval on first action
**Auto-pause:** `GameEngine.checkAutoPause()` - uses telegraph.pause field
**Skill loading:** `GameEngine.loadSkills()` - fetches JSON from `/public/CombatSkills/`

### Build Commands:

```bash
npm run dev              # Start dev server
npm run build:skills     # Rebuild all skills from CSV
npm run validate:skills  # Validate CSV without writing
```

### Timing Reference:

**Tick rate:** 50ms (20 ticks per second)
**Fastest attack:** thrust (250ms windUp, 850ms impact, 1550ms total)
**Slowest attack:** diagonal_slash (600ms windUp, 1900ms impact, 2500ms total)
**Emergency defense:** 100ms windUp (last resort timing)
**Parry/Deflection recovery:** 200ms (shortest, enables riposte)

### Damage Reference:

**HP:** 3 for both PC and NPC
**Base damage:** 3 for all attacks
**Death:** HP <= 0
**Formula:** `finalDamage = attackDamage * (1 - damageReductionPercent) - damageReductionFlat`

**Defense reductions:**
- Emergency Defense: 2 flat ‚Üí 1 damage taken
- Retreat: 100% reduction ‚Üí 0 damage
- Parry: 3 flat ‚Üí 0 damage
- Deflection: 3 flat ‚Üí 0 damage

### Git Commands User Learned (Nov 12):

**View single commit:**
```bash
git show <hash> --no-patch  # Message only
git log -1 <hash>           # Full details
```

**View commit history:**
```bash
git log --since="today" --format=medium
git log --since="2025-11-11 08:00:00" --format=medium
```

---

## üìù Recent Conversation Summary (Nov 12)

**Topic:** User learning to navigate React+Tailwind codebase

**Key Questions User Asked:**
1. Where to find button styling in React components
2. How `renderSkillButton` template function works
3. Why Feint doesn't use the template
4. Why React+Tailwind approach is better than HTML/CSS
5. How to search for component definitions
6. Git commands for reviewing commit history

**User's Learning Journey:**
- Started by reading existing code files
- Asked questions about React patterns
- Expressed frustration with React+Tailwind readability
- Confirmed understanding of search patterns
- Created own documentation file
- Reviewed git history to understand recent changes

**No coding tasks requested** - entire conversation was learning and understanding.

**User created:** `extra_context/how to change buttons.md` - documentation for navigating React components

**Recent Commits (Nov 11, 2025):**
1. `9bbba7c` - "before refactoring buttons" (backup commit)
2. `bd197f2` - "Deflect predict attack modal changed to portal"
3. `77e56ee` - "all oter updates"
4. `b3b069f` - "Redesign action buttons with improved layout and hover tooltips" (401 insertions, 43 deletions)
5. `f430fd6` - "Fix FeintSelectionModal z-index layering issue using React Portal"
6. `acbd97f` - "Implement wait button fix, emergency defense repositioning, and feint system"
7. `2984621` - "Implement defense prediction UI and counter speed bonus mechanics"

---

## ü§ù Good Luck!

The codebase is clean, well-commented, and working. The HP-based damage system is fully implemented. The 50ms tick system provides precise timing. The CSV build system makes skill iteration fast. The UI has been redesigned with better UX. All modals use React Portals.

**The user is engaged and learning.** They're transitioning from HTML/CSS to React+TypeScript. Be patient, provide clear explanations with examples, and help them build mental models of React patterns.

**Start here:**
1. Read `CLAUDE.md` - User instructions
2. Read `Combat3 - atomic_turns.md` - Understand the phase system
3. Read `PRD.md` - Understand current implementation
4. Read `CombatTypes.ts` - Understand data model
5. Read `GameEngine.ts` - Core combat logic
6. Read `public/CombatSkills/README.md` - CSV workflow
7. Read `extra_context/how to change buttons.md` - User's navigation guide

**Most important recent changes:**
- Action buttons redesigned with hover tooltips (Nov 11)
- React Portal pattern for all modals (Nov 11)
- Counter speed bonus mechanics (Nov 11)
- Defense prediction UI (Nov 11)
- Feint system (Nov 11)
- User documentation for navigating React components (Nov 12)

**When working with this user:**
- Explain React patterns clearly
- Show file paths with line numbers
- Offer multiple approaches when confusion arises
- Be patient with learning questions
- Encourage user to document their learning

**When in doubt:**
- Check the CSV files to see data structure
- Read buildSkills.cjs comments for build logic
- Check CombatTypes.ts for type definitions
- Look at generated JSON for expected format
- Read GameEngine.ts for implementation details
- Read user's documentation in extra_context/
- Test in the running prototype (npm run dev)
