# Handover Document - Combat Prototype
**Date:** 2025-11-10
**Status:** CSV build system complete, 10 skills working (5 attacks + 4 defenses + 1 special)
**For:** Next AI agent continuing development

---

## ğŸ¯ What You're Inheriting

A **working tactical CRPG combat prototype** with a complete **CSV-to-JSON build pipeline**. The core engine runs, skills are data-driven from CSV files, and the UI shows both fighters' actions side-by-side.

**Major Milestone:** All combat skills are now managed through CSV files for easy balancing and iteration.

**Tech Stack:**
- React + TypeScript + Vite (hot reload works)
- Tailwind CSS v3.4.17 âš ï¸ (LOCKED - v4 causes issues, never upgrade)
- Node.js build scripts (CommonJS)
- 100% browser-based, no backend

**Run it:**
```bash
cd combat-prototype
npm run dev          # Start dev server at http://localhost:5173/
npm run build:skills # Rebuild all skills from CSV
npm run validate:skills # Check CSV without writing files
```

---

## ğŸ“š Where to Find Information

### Primary Design Documents (read these first):
1. **`Combat3 - atomic_turns.md`** - The combat phase system, atomic turns
2. **`PRD.md`** - Resource system, damage rules, combat skills
3. **`CODE_GUIDE.md`** - How the codebase works
4. **`public/CombatSkills/README.md`** - **NEW!** Complete CSV workflow guide
5. **`public/CombatSkills/defense/CombatSkills-defense.md`** - Defense skill designs

### Code Files to Understand:
1. **`src/types/CombatTypes.ts`** - ALL type definitions (start here)
2. **`src/engine/GameEngine.ts`** - Core combat logic, atomic tick loop
3. **`scripts/buildSkills.cjs`** - **NEW!** CSVâ†’JSON build system (heavily commented)
4. **`src/components/CombatScene.tsx`** - Main container (3-column layout)
5. **`src/components/Actions/ActionPanel.tsx`** - Action buttons (left/right panels)
6. **`src/components/Timeline/TimelinePanel.tsx`** - 5 synchronized timebars

### CSV Data (Source of Truth):
- **`public/CombatSkills/attacks/CombatSkills-attack.csv`** - 5 attack skills
- **`public/CombatSkills/defense/CombatSkills-defense.csv`** - 4 defense skills
- **`public/CombatSkills/special/CombatSkills-special.csv`** - 1 special skill (feint)

**IMPORTANT:** Edit CSV files, NOT JSON files! JSON is auto-generated.

### JSON Data (Auto-Generated):
- **`public/CombatSkills/attacks/*.json`** - Generated attack skills
- **`public/CombatSkills/defense/*.json`** - Generated defense skills
- **`public/CombatSkills/special/*.json`** - Generated special skills

---

## âš¡ Critical Context Not in Docs

### 1. **CSV Build System is the Data Management Layer**
**All combat skills come from CSV files.** JSON files are generated artifacts.

**Workflow:**
1. Edit CSV file (skills as columns for easy comparison)
2. Run `npm run build:skills`
3. Build script generates JSON with auto-calculated values
4. Game engine loads JSON at runtime

**Why CSV as columns:**
```csv
id,overhead_strike,side_slash,thrust
name,Overhead Strike,Horizontal Strike,Thrust
windUp_duration,400,500,250
```
- Easy visual comparison across all skills
- Fast bulk editing in text editor (VSCode)
- Git diff shows what changed

**Build script features:**
- Auto-calculates `impact_tick = windUp + committed`
- Auto-generates `type`, `school`, `stage` numbers
- Dynamically detects telegraph stages (t1, t2, ..., t99+, no limit!)
- Checks for missing assets (warns but doesn't fail)
- Validates timing values (errors on mismatch)
- Supports attacks, defenses, AND special skills

**File:** `scripts/buildSkills.cjs` (heavily commented, ~580 lines)

### 2. **Impact Uses TICK Approach, Not Duration**
**Tick is better** for this atomic system.

**JSON format:**
```json
{
  "windUp": { "duration": 400 },
  "committed": { "duration": 800 },
  "impact": { "tick": 1200 },  // â† Absolute time, NOT duration
  "recovery": { "duration": 800 }
}
```

**In CSV:**
```csv
windUp_duration,400,500,250
committed_duration,800,800,600
impact_tick,AUTO,AUTO,AUTO  # Auto-calculated!
recovery_duration,800,500,700
```

**Why tick won:**
- Clearer tactical communication: "Attack hits at 1200ms"
- Impact is instant event, not sustained phase
- Telegraphs use absolute times already
- Easier for designers to balance

**Build script validation:** Fails if `impact_tick â‰  windUp + committed`

### 3. **Telegraph System is Universal**
**All skill types can have telegraphs** (attacks, defenses, specials).

**CSV format (same for all types):**
```csv
# Telegraph Stage 1
t1_triggerTime,0,0,0
t1_assetId,shoulders_tense,weight_shift_back,eyes_widen
t1_bodyPart,shoulders,foot,eyes
t1_description,Shoulders tens up,Weight shifts to back foot,...
t1_pause,true,true,true
# Telegraph Stage 2
t2_triggerTime,100,100,100
# ... (t3_, t4_, t5_, ... unlimited stages)
```

**Build script detects stages dynamically:**
- Looks for `t{N}_` pattern
- No hard limit on stage count
- Stages auto-numbered in JSON
- Missing stages OK (skill can have 0 telegraphs)

**Telegraph purpose by skill type:**
- **Attacks:** Show attacker's intent to defender (traditional)
- **Defenses:** Show defender's commit to attacker (enables feints!)
- **Specials:** Show special action in progress (feint morph stages)

**`pause` field:** Controls auto-pause on telegraph reveal
- `true` = game pauses when this telegraph triggers
- `false` = telegraph reveals but no pause

### 4. **Asset Management is Convention-Based**
**Assets are referenced by `assetId`, not file paths.**

**Convention:**
```csv
t1_assetId,shoulders_tense
```

Looks for:
- `public/assets/telegraphs/shoulders_tense.png` (static image)
- `public/assets/telegraphs/shoulders_tense.mp4` (video animation)
- `public/assets/telegraphs/shoulders_tense_anim.json` (animation data)

**Any combination is valid.** Multiple skills can share same assetId.

**Missing assets:**
- Build script warns but doesn't fail
- Placeholder asset used in game: `public/assets/telegraphs/placeholder.png`
- Intentional for prototyping phase

### 5. **Line System is Core Tactical Mechanic**
**Every attack has a line (direction).** Defenses interact with lines.

**Line values:**
- `high` - Overhead attacks
- `horizontal` - Side slashes
- `center` - Thrusts, center line
- `low` - Rising attacks from below
- `diagonal` - Angled attacks

**Defense interactions:**
- **Parry:** Requires correct line declared (`requiresLine: true`)
- **Deflection:** Requires specific attack predicted (`requiresAttackId: true`)
- **Emergency Defense:** No requirements (`requiresLine: false`)
- **Retreat:** Movement-based, no line (`requiresLine: false`)

**Feint mechanics:** Must morph to DIFFERENT line than original attack

**CSV field (attacks only):**
```csv
line,high,horizontal,center,low,diagonal
```

### 6. **UI Layout is 3-Column**
**Changed from stacked layout to side-by-side.**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PC Actions  â”‚  Center Content  â”‚ NPC Actions â”‚
â”‚  (left)     â”‚  (Timeline, Log) â”‚  (right)    â”‚
â”‚  w-64       â”‚    flex-1        â”‚  w-64       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ActionPanel.tsx** accepts `fighter` prop:
```typescript
<ActionPanel fighter="pc" ... />
<ActionPanel fighter="npc" ... />
```

**Tailwind warning:** Don't use template literals for dynamic classes!
```typescript
// WRONG - purged at build time
className={`text-${color}-400`}

// RIGHT - conditional expressions
className={fighter === 'pc' ? 'text-green-400' : 'text-red-400'}
```

### 7. **Defense Skills Have Active Windows, Not Committed Phase**
**Defense structure differs from attacks.**

**Phases:**
- `windUp` - Preparing defense
- `active` - Defense is ready, auto-triggers on impact (NOT committed!)
- `recovery` - Resetting to guard

**CSV format:**
```csv
windUp_duration,100,200,300,300
active_duration,200,400,500,500  # NOT committed_duration!
recovery_duration,500,300,200,200
```

**Special case:** `active_duration` can be `N/A` for instant movement (retreat)

**Defense properties:**
```csv
requiresLine,false,false,true,false
requiresAttackId,false,false,false,true
defenseType,emergency,movement,deflection,deflection
damageReduction,0.5,1.0,1.0,1.0
counterSpeedBonus,0,0,100,300
```

**counterSpeedBonus:** Milliseconds reduced from next attack windUp
- Parry: 100ms bonus (slight advantage)
- Deflection: 300ms bonus (massive riposte opportunity!)

### 8. **Special Skills Have Unique Execution Flow**
**Feint is attack morphing, not attack canceling.**

**How feint works:**
1. Attacker starts attack (e.g., overhead_strike on `high` line)
2. Defender commits to defense (e.g., parry on `high` line)
3. Attacker sees defender's telegraph (stages 2-3)
4. Attacker triggers feint â†’ morphs to different attack (e.g., side_slash on `horizontal`)
5. 100ms time penalty applied
6. New attack windUp starts from 0 + 100ms penalty
7. Original attack stamina lost + new attack stamina * 1.4x

**Timing:**
```csv
recognitionTime,0      # Instant read
adjustmentTime,100     # Morph transition
timePenalty,100        # Added to new attack windUp
```

**Stamina:**
```csv
staminaMultiplier,1.4  # 40% penalty for changing momentum
```

**Requirements:**
- Available only during windUp phase
- Must read defender's telegraph (defender must be in windUp stages 2-3)
- New attack must be on different line

**Special skill CSV has unique fields:**
- `specialType`, `requiresActiveAttack`, `requiresDefenderTelegraph`
- `executionFlow`, `resetBehavior`, `newAttackStartTime`
- `onSuccessfulRead`, `onMisread`, `counterplayAvailable`

### 9. **Skill Renaming: slash â†’ side_slash**
**Old name:** slash
**New name:** side_slash

**Updated in:**
- CSV: `id` column value
- JSON filename: `side_slash.json`
- GameEngine.ts: skill loading (3 references)
- ActionPanel.tsx: button references

**Pattern for future renames:**
1. Update CSV `id` row
2. Run `npm run build:skills`
3. Search codebase for old name
4. Update all references

### 10. **Both Fighters Manually Controlled (For Now)**
**No AI yet.** User simulates both fighters to test mechanics.

PC actions on left, NPC actions on right. This is intentional for prototyping.

### 11. **Telegraph Display Shows Opponent's Telegraphs**
When opponent executes skill with telegraphs, they appear in YOUR action panel.

**Example:** NPC uses side_slash
- PC action panel shows "NPC Telegraph Stages" box
- All 4 stages listed with trigger times
- Revealed stages highlighted (based on currentTick)
- Unrevealed stages dimmed

### 12. **Combat Log is Reverse Chronological**
Newest entries at TOP, not bottom.

```typescript
gameState.combatLog.slice().reverse().map(...)
```

User prefers this for easier reading of recent events.

---

## ğŸ—ï¸ Architecture Patterns

### CSV Build System Flow:
```
CSV Files (source of truth)
  â†“ npm run build:skills
buildSkills.cjs
  â†“ parseCSV()
  â†“ detectTelegraphStages()
  â†“ buildAttackSkill() / buildDefenseSkill() / buildSpecialSkill()
  â†“ validateSkill()
  â†“ checkAssets()
JSON Files (generated)
  â†“ fetch at runtime
GameEngine.loadSkills()
```

**Key functions in buildSkills.cjs:**
- `parseCSV()` - Parses skills-as-columns format
- `detectTelegraphStages()` - Finds all t{N}_ properties dynamically
- `checkAssets()` - Looks for .png/.mp4/_anim.json
- `buildAttackSkill()` - Generates attack JSON with validation
- `buildDefenseSkill()` - Generates defense JSON with telegraphs
- `buildSpecialSkill()` - Generates special JSON with unique mechanics

### Event-Driven Game Loop:
```
GameEngine (pure TypeScript, no React)
  â†“ emits events every tick
React Components
  â†“ re-render
UI updates
```

**Key insight:** Engine has zero React dependencies. UI is just a listener.

### Atomic Tick Loop:
```typescript
setInterval(() => {
  this.currentTick += 100;  // Advance time
  this.updateFighter(this.pc);
  this.updateFighter(this.npc);
  this.checkAutoPause();
  this.emitStateUpdate();  // â†’ React
}, 100);
```

Everything happens in 100ms increments. Deterministic, no RNG.

### Phase Progression:
```typescript
if (elapsed < windUpEnd) â†’ windUp
else if (elapsed < impactTick) â†’ committed (or active for defense)
else if (elapsed === impactTick) â†’ impact (ONE tick only!)
else if (elapsed < recoveryEnd) â†’ recovery
else â†’ action complete, clear it
```

Impact resolves **once** when entering impact phase.

---

## ğŸ”§ Current Skill Inventory

### âœ… Implemented Skills (10 total):

**Attacks (5):**
1. `overhead_strike` - Vertical overhead, high line, 400ms windUp
2. `side_slash` - Horizontal slash, horizontal line, 500ms windUp
3. `thrust` - Forward stab, center line, 250ms windUp (fastest)
4. `upward_strike` - Rising attack, low line, 400ms windUp
5. `diagonal_slash` - Angled cut, diagonal line, 600ms windUp (slowest)

**Defenses (4):**
1. `emergency_defense` - Last resort, 100ms windUp, 50% damage reduction, 500ms recovery
2. `retreat` - Movement, 200ms windUp, full dodge, 300ms recovery
3. `parry` - Line-based block, 300ms windUp, requires correct line, 100ms counter bonus
4. `deflection` - Perfect counter, 300ms windUp, requires attack ID, 300ms counter bonus, 200ms recovery (riposte!)

**Special (1):**
1. `feint` - Attack morph, reads defender telegraph, 100ms penalty, 1.4x stamina cost

**All skills have 4-stage telegraphs with pause triggers.**

### ğŸ“Š Skill Balance (from CSV):

**Fastest attack:** thrust (250ms windUp, 850ms total time)
**Slowest attack:** diagonal_slash (600ms windUp, 1700ms total time)
**Best counter defense:** deflection (0ms recovery = instant riposte!)
**Last resort:** emergency_defense (100ms windUp = very late reaction)

---

## ğŸ› Past Issues Solved (Don't Repeat)

1. **Tailwind CSS v4 incompatibility** - Locked to v3.4.17, never upgrade
2. **Duration vs Tick for impact** - Tick won (see section 2)
3. **Pause blocking input** - Fixed, pause doesn't disable buttons
4. **Timeline bars shrinking** - Fixed with overlaid text
5. **Dynamic class names in Tailwind** - Use conditionals, NOT template literals
6. **NaN in impact calculations** - Fixed by passing csvData.data directly
7. **Duplicate JSON files** - Old capitalized names removed (e.g., "Horizontal Strike.json")
8. **Defense telegraphs missing** - Added to CSV and build script

---

## ğŸ“‹ Known Limitations & Next Steps

### âš ï¸ Current Limitations:
- **No asset files** - All telegraphs use placeholder.png
- **Manual fighter control** - No NPC AI yet
- **Limited skill loading** - GameEngine may still load only 3 skills (check `loadSkills()`)
- **No visual telegraphs** - Only combat log messages
- **Feint not implemented in engine** - JSON exists but logic not in GameEngine.ts
- **Defense mechanics partial** - Active windows not fully implemented
- **No combo system** - Each skill is independent

### ğŸ¯ Likely Next Requests:

**High Priority:**
1. Implement feint mechanics in GameEngine.ts
2. Implement defense active windows properly
3. Load all 10 skills in GameEngine (not just 3)
4. Add visual telegraph indicators (images/animations)
5. Create actual telegraph assets (replace placeholders)

**Medium Priority:**
6. NPC AI decision tree
7. Combo system (skill chaining)
8. More attack/defense skills
9. Counter attack system (use counterSpeedBonus)
10. Damage system beyond instant death

**Lower Priority:**
11. UI polish/animations
12. Sound effects
13. Skill unlock progression
14. Tutorial/tooltips

**User might ask to:**
- Adjust CSV timing values and rebuild
- Add new skills via CSV
- Balance stamina costs
- Change telegraph trigger times
- Add new special skills

---

## ğŸ¯ What User Cares About

### High Priority:
- **CSV workflow** - Easy skill balancing without touching code
- **Combat feel** - Timing must be clear and fair
- **Telegraph system** - Reading and counter-reading telegraphs
- **No RNG** - Everything deterministic
- **Learning TypeScript** - User wants to understand how it works

### Less Priority (For Now):
- UI polish/animations
- React patterns/best practices
- Performance optimization
- Code organization/refactoring
- Documentation (unless requested)

**User's words:** "TypeScript is a must. I want to understand how it works. Then UI is secondary I just want it to work."

---

## ğŸ’¡ Working With This User

**Communication style:**
- Prefers concise, accurate explanations
- Will edit CSV/code files directly
- Likes seeing options/trade-offs before choosing
- Values technical accuracy over validation
- New to TypeScript, appreciates clear type explanations

**When explaining code:**
- Show file path with line numbers: `GameEngine.ts:245`
- Explain TypeScript types clearly
- Reference design docs by name
- Use examples from actual codebase
- Mention if reading docs would help

**Red flags (DON'T do this):**
- âŒ Don't create documentation files unprompted
- âŒ Don't refactor unless asked
- âŒ Don't add emojis unless requested
- âŒ Don't guess at URLs
- âŒ Don't update git without being asked

**User instructions from CLAUDE.md:**
1. Double-check things, be skeptical, do research
2. User is not always right (neither are you)
3. Stick to React best practices (avoid unnecessary effects)

---

## ğŸ” Quick Reference

### File Locations:
**Engine:** `src/engine/GameEngine.ts` (~400 lines)
**Types:** `src/types/CombatTypes.ts` (Telegraph interface has `assetId` field)
**Build script:** `scripts/buildSkills.cjs` (~580 lines, heavily commented)
**React entry:** `src/components/CombatScene.tsx` (3-column layout)
**Action panel:** `src/components/Actions/ActionPanel.tsx` (accepts `fighter` prop)

### Key Functions:
**Main loop:** `GameEngine.tick()` - runs every 100ms
**Phase update:** `GameEngine.updateFighterPhase()` - checks elapsed time
**Impact resolution:** `GameEngine.resolveImpact()` - called once at impact tick
**Telegraph check:** `GameEngine.checkTelegraphReveal()` - compares triggerTime to elapsed
**Auto-pause:** `GameEngine.checkAutoPause()` - uses telegraph.pause field
**Skill loading:** `GameEngine.loadSkills()` - fetches JSON from `/public/CombatSkills/`

### Build Commands:
```bash
npm run dev              # Start dev server
npm run build:skills     # Rebuild all skills from CSV
npm run validate:skills  # Validate CSV without writing
```

### Timing Reference:
**Tick rate:** 100ms (10 ticks per second)
**Fastest attack:** thrust (250ms windUp, 850ms total)
**Slowest attack:** diagonal_slash (600ms windUp, 1700ms total)
**Emergency defense:** 100ms windUp (last resort timing)
**Deflection recovery:** 200ms (shortest, enables riposte)

### CSV Editing Workflow:
1. Open CSV in text editor (VSCode with CSV Rainbow extension recommended)
2. Edit values (skills are columns for easy comparison)
3. Save file
4. Run `npm run build:skills`
5. Check console for errors/warnings
6. Test in game (dev server auto-reloads)

**Important:** `impact_tick,AUTO,AUTO,AUTO` means build script calculates it. Set to `AUTO` unless you have a specific reason to override.

---

## ğŸ¤ Good Luck!

The codebase is clean, well-commented, and working. The CSV build system makes skill iteration fast. The user is engaged and gives clear feedback.

**Start here:**
1. Read `public/CombatSkills/README.md` - Complete CSV workflow guide
2. Read `CombatTypes.ts` - Understand data model (note: Telegraph has `assetId`, DefenseProperties has `counterSpeedBonus`)
3. Read `scripts/buildSkills.cjs` - See how CSVâ†’JSON works (heavily commented)
4. Run `npm run build:skills` - See the build system in action
5. Read `Combat3 - atomic_turns.md` - Understand the phase system

**Most important patterns:**
- CSV is source of truth, JSON is generated
- Edit CSV, run build, test in game
- Telegraphs are universal (attacks, defenses, specials)
- Dynamic telegraph detection (no hard limits)
- impact_tick = windUp + committed (validated!)
- assetId for asset management (convention-based)

**When in doubt:**
- Check the CSV files to see data structure
- Read buildSkills.cjs comments for build logic
- Check CombatTypes.ts for type definitions
- Look at generated JSON for expected format
- Read README.md in CombatSkills folder

You've got this! ğŸš€

**P.S.** The old handover mentioned loading only 3 skills - check if GameEngine.loadSkills() needs updating to load all 10 skills from the new CSV-generated files.
