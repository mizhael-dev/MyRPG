# Handover Document - Timeline & Pause System Implementation

**Date:** 2025-11-12
**Status:** Timeline visualization complete, pause system fully functional
**For:** Next AI agent continuing development

---

## ğŸ¯ What You're Inheriting

A **working tactical CRPG combat prototype** with a **complete timeline visualization system** showing phase-colored action bars on a moving film strip display, and a **fully functional pause system** with three pause types (telegraph, recovery complete, death).

**Today's Major Changes (2025-11-12):**

- âœ… **Timeline visualization implemented** - Film strip behavior with 5 synchronized timebars
- âœ… **Action history tracking** - GameEngine records all completed actions with phase timestamps
- âœ… **View mode decluttering** - PC/NPC views show only relevant timebars (2 instead of 5)
- âœ… **Recovery complete pause** - Auto-pause when fighter finishes recovery phase
- âœ… **Telegraph pause system fixed** - Opponent can act when telegraph reveals
- âœ… **Pause permission checks** - Fighters can't act when it's not their turn
- âœ… **Auto-unpause** - Game resumes after valid action during pause
- âœ… **Combat log filtering** - Messages visible in correct view modes

**Tech Stack:**

- React + TypeScript + Vite (hot reload works)
- Tailwind CSS v3.4.17 âš ï¸ (LOCKED - v4 causes issues, never upgrade)
- Node.js build scripts (CommonJS)
- 100% browser-based, no backend

**Run it:**

```bash
cd combat-prototype
npm run dev          # Start dev server at http://localhost:5173/
npm run build:skills # Rebuild all skills from CSV
npm run validate:skills # Check CSV without writing files
```

---

## ğŸ“‚ Project Structure

```
MyRPG/
â”œâ”€â”€ .claude/                            # Claude Code settings
â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”œâ”€â”€ handover.md                 # Handover command
â”‚   â”‚   â””â”€â”€ onboard.md                  # Onboarding command
â”‚   â””â”€â”€ settings.local.json             # Local Claude settings
â”‚
â”œâ”€â”€ .vscode/
â”‚   â””â”€â”€ settings.json                   # VSCode settings
â”‚
â”œâ”€â”€ Backlog-Later/                      # Future features
â”‚   â”œâ”€â”€ Player_Character_Sheet.md
â”‚   â””â”€â”€ Resource System.md
â”‚
â”œâ”€â”€ combat-prototype/                   # **MAIN COMBAT PROTOTYPE**
â”‚   â”œâ”€â”€ dist/                           # Build output (generated)
â”‚   â”‚   â”œâ”€â”€ assets/
â”‚   â”‚   â””â”€â”€ CombatSkills/               # Copied from public/
â”‚   â”‚
â”‚   â”œâ”€â”€ public/
â”‚   â”‚   â”œâ”€â”€ assets/
â”‚   â”‚   â”‚   â””â”€â”€ telegraphs/
â”‚   â”‚   â”‚       â””â”€â”€ README.md           # Asset management guide
â”‚   â”‚   â””â”€â”€ CombatSkills/               # **Skill data (CSV + JSON)**
â”‚   â”‚       â”œâ”€â”€ README.md               # **START HERE** - CSV workflow guide
â”‚   â”‚       â”œâ”€â”€ attacks/
â”‚   â”‚       â”‚   â”œâ”€â”€ CombatSkills-attack.csv     # **Source of truth for attacks**
â”‚   â”‚       â”‚   â”œâ”€â”€ diagonal_slash.json         # Generated
â”‚   â”‚       â”‚   â”œâ”€â”€ overhead_strike.json        # Generated
â”‚   â”‚       â”‚   â”œâ”€â”€ side_slash.json             # Generated
â”‚   â”‚       â”‚   â”œâ”€â”€ thrust.json                 # Generated
â”‚   â”‚       â”‚   â””â”€â”€ upward_strike.json          # Generated
â”‚   â”‚       â”œâ”€â”€ defense/
â”‚   â”‚       â”‚   â”œâ”€â”€ CombatSkills-defense.csv    # **Source of truth for defenses**
â”‚   â”‚       â”‚   â”œâ”€â”€ CombatSkills-defense.md     # Defense skill designs
â”‚   â”‚       â”‚   â”œâ”€â”€ deflection.json             # Generated
â”‚   â”‚       â”‚   â”œâ”€â”€ emergency_defense.json      # Generated
â”‚   â”‚       â”‚   â”œâ”€â”€ parry.json                  # Generated
â”‚   â”‚       â”‚   â””â”€â”€ retreat.json                # Generated
â”‚   â”‚       â”œâ”€â”€ special/
â”‚   â”‚       â”‚   â”œâ”€â”€ CombatSkills-special.csv    # **Source of truth for specials**
â”‚   â”‚       â”‚   â””â”€â”€ feint.json                  # Generated
â”‚   â”‚       â””â”€â”€ combos/
â”‚   â”‚           â””â”€â”€ slash_slash_thrust.json     # Combo example (not implemented)
â”‚   â”‚
â”‚   â”œâ”€â”€ scripts/
â”‚   â”‚   â””â”€â”€ buildSkills.cjs             # **CSVâ†’JSON build system** (~580 lines)
â”‚   â”‚
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ Actions/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ActionPanel.tsx     # **Action buttons** (skill buttons with tooltips)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ LineSelectionModal.tsx      # Parry line selection (React Portal)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AttackPredictionDropdown.tsx # Deflection attack prediction (React Portal)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ FeintSelectionModal.tsx     # Feint attack selection (React Portal)
â”‚   â”‚   â”‚   â”œâ”€â”€ Timeline/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ TimelinePanel.tsx   # **5 timebars with film strip behavior**
â”‚   â”‚   â”‚   â”œâ”€â”€ CombatScene.tsx         # **Main container** (3-column layout, combat log)
â”‚   â”‚   â”‚   â””â”€â”€ ViewModeSelector.tsx    # View mode toggle (PC/NPC/Debug)
â”‚   â”‚   â”œâ”€â”€ engine/
â”‚   â”‚   â”‚   â””â”€â”€ GameEngine.ts           # **CORE** - Combat logic, pause system (~890 lines)
â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â””â”€â”€ CombatTypes.ts          # **START HERE** - ALL type definitions
â”‚   â”‚   â”œâ”€â”€ App.tsx                     # React app entry
â”‚   â”‚   â””â”€â”€ main.tsx                    # Vite entry
â”‚   â”œâ”€â”€ package.json                    # Dependencies
â”‚   â”œâ”€â”€ tsconfig.json                   # TypeScript config
â”‚   â””â”€â”€ vite.config.ts                  # Vite config
â”‚
â”œâ”€â”€ extra_context/                      # Historical docs
â”‚   â”œâ”€â”€ 20251108_handover.md
â”‚   â”œâ”€â”€ Combat3 - TechStack.md
â”‚   â”œâ”€â”€ how to change buttons.md        # User guide for button modifications
â”‚   â””â”€â”€ SETUP_GUIDE.md
â”‚
â”œâ”€â”€ Backlog-Later/                      # Future features
â”‚   â”œâ”€â”€ Player_Character_Sheet.md
â”‚   â””â”€â”€ Resource System.md
â”‚
â”œâ”€â”€ .claude/                            # Claude Code settings
â”‚   â””â”€â”€ commands/
â”‚       â”œâ”€â”€ handover.md                 # This command
â”‚       â””â”€â”€ onboard.md
â”‚
â”œâ”€â”€ 20251110_handover.md                # Previous handover
â”œâ”€â”€ 20251110_defensive_skills_implementation.md  # Defense implementation notes
â”œâ”€â”€ 20251111_1_handover.md              # Button redesign handover
â”œâ”€â”€ 20251112_1_handover.md              # Morning session handover
â”œâ”€â”€ 20251112_Timelines-implementation.md # **Timeline implementation guide**
â”œâ”€â”€ 20251112_2_handover.md              # **THIS FILE**
â”œâ”€â”€ Timelines-design.md                 # **Timeline design specification**
â”œâ”€â”€ Atomic_Turns.md                     # Early atomic turn design
â”œâ”€â”€ Claude_Summary.md                   # Project vision & design analysis
â”œâ”€â”€ CODE_GUIDE.md                       # How the codebase works
â”œâ”€â”€ Combat3 - atomic_turns.md           # **ESSENTIAL** - Phase system, atomic turns
â”œâ”€â”€ CombatSkillData-DesignDoc.md        # Skill data design
â”œâ”€â”€ PRD.md                              # **ESSENTIAL** - Resource system, damage rules
â”œâ”€â”€ CLAUDE.md                           # User instructions for AI agents
â”œâ”€â”€ package.json                        # Root dependencies
â””â”€â”€ README.md                           # Combat prototype readme
```

---

## ğŸ“š Reading List (Read in Order)

### Essential Reading (Start Here):

1. **`CLAUDE.md`** - User instructions and working agreements
   - How to work with this user
   - React best practices (don't overuse effects)
   - Be skeptical, do research

2. **`Timelines-design.md`** - Timeline mechanics specification
   - Atomic resolution (no turn order)
   - Auto-pause triggers (telegraphs, recovery, death)
   - Phase system (wind-up, committed, active, impact, recovery)
   - Timeline types (Own Actual, Opponent Predicted, Combined)

3. **`20251112_Timelines-implementation.md`** - Timeline implementation guide
   - Configuration constants (PAST_MS, ZOOM_MS, etc.)
   - Film strip approach (fixed viewport, moving content)
   - Data structures (ActionHistoryEntry)
   - Future extensions (hover preview, telegraph markers)

4. **`Combat3 - atomic_turns.md`** - The combat phase system
   - 50ms atomic tick system
   - Phase progression (windUp â†’ committed â†’ impact â†’ recovery)
   - Telegraph mechanics
   - Defense timing windows

5. **`PRD.md`** - Product requirements document
   - HP-based damage system (lines 182-203)
   - Resource system (4-layer design)
   - Combat skills definitions
   - Current implementation status

6. **`combat-prototype/src/types/CombatTypes.ts`** - ALL type definitions
   - FighterState, ActionState, GameState
   - CombatSkill structure
   - ActionHistoryEntry (lines 195-211)
   - PauseState, PauseReason (lines 217-239)

7. **`combat-prototype/src/engine/GameEngine.ts`** - Core combat logic
   - Atomic tick loop (runs every 50ms)
   - Action history tracking (lines 95-99, 348-360, 406-420, 438-484)
   - Pause system (lines 687-728, 757-764, 865-872)
   - Phase progression (lines 303-396)
   - Impact resolution (lines 524-598)

8. **`combat-prototype/src/components/Timeline/TimelinePanel.tsx`** - Timeline visualization
   - Configuration constants (lines 22-82)
   - Film strip calculations (lines 127-150)
   - View mode filtering (lines 174-179)
   - Dynamic layout (lines 181-213)
   - Action bar rendering (lines 409-500)

### Recent Changes & Context:

9. **`20251112_1_handover.md`** - Button redesign handover
   - Action button improvements
   - React Portal pattern for modals
   - Defense prediction UI
   - Feint system

10. **`20251111_1_handover.md`** - Previous handover
    - HP-based damage system
    - 50ms tick interval
    - Defense active window
    - CSV build system

11. **`CODE_GUIDE.md`** - How the codebase works
    - Architecture patterns
    - File organization
    - Key functions

### Secondary Reading (Reference):

12. **`Claude_Summary.md`** - Project vision
    - Grimdark tactical CRPG
    - No RNG philosophy
    - Character system
    - Resource cascade

13. **`combat-prototype/scripts/buildSkills.cjs`** - CSVâ†’JSON build system
    - Heavily commented (~580 lines)
    - Auto-calculation logic
    - Validation rules

14. **`combat-prototype/public/CombatSkills/README.md`** - CSV workflow guide
    - How to edit skills via CSV
    - Build system workflow

---

## âš¡ Critical Context Not in Docs

### 1. **Timeline System (IMPLEMENTED TODAY)**

**Film Strip Behavior:**

The timeline uses a fixed viewport with moving content via CSS transform. The "now" line stays at 33% from the left (1s past visible, 2s future visible).

```typescript
// TimelinePanel.tsx configuration
PAST_MS: 1000,      // 1 second of history visible
ZOOM_MS: 3000,      // 3 seconds total visible
```

**Key Implementation Details:**

- **Fixed viewport:** 100% width, clips content
- **Moving content:** CSS `transform: translateX()` moves left as time advances
- **"Now" line:** Fixed at `(PAST_MS / ZOOM_MS) * 100%` from left edge
- **Smooth animation:** `transition: transform 50ms linear` matches tick interval
- **Phase colors:** Green (wind-up), Yellow (committed), Grey (active/impact), Red (recovery)

**Five Timebars:**

1. **PC_actual** - Shows PC's skill name, full action with phases
2. **PC_seen_by_NPC** - PC's action without skill name (opponent's view)
3. **NPC_actual** - Shows NPC's skill name, full action with phases
4. **NPC_seen_by_PC** - NPC's action without skill name (player's view)
5. **Combined** - Both fighters on split bar (debug only)

**View Mode Filtering:**

- **PC view:** Shows only `PC_actual` and `NPC_seen_by_PC` (2 timebars)
- **NPC view:** Shows only `NPC_actual` and `PC_seen_by_NPC` (2 timebars)
- **Debug view:** Shows all 5 timebars

**Action History:**

```typescript
interface ActionHistoryEntry {
  fighterId: 'pc' | 'npc';
  skill: CombatSkill;
  startTick: number;
  endTick: number;
  phases: {
    windUpEnd: number;
    committedEnd?: number;  // Attacks only
    activeEnd?: number;     // Defenses only
    impactTick?: number;    // Attacks only
    recoveryEnd: number;
  };
  windUpModifier?: number;  // Counter speed bonus
}
```

**Implementation:** `TimelinePanel.tsx` (lines 1-501), `GameEngine.ts` (lines 95-99, 348-360, 406-420, 438-484)

### 2. **Pause System (FIXED TODAY)**

**Three Pause Types:**

1. **Telegraph Pause** (`new_telegraph`)
   - Triggers when telegraph with `pause: true` is revealed
   - **Opponent** of telegraphing fighter can act
   - Example: PC telegraphs â†’ NPC can respond

2. **Recovery Complete Pause** (`recovery_complete`)
   - Triggers when action recovery ends
   - **That fighter** can act again
   - Message: "{name} is ready to act again"

3. **Death Pause** (`manual` placeholder)
   - Triggers when HP <= 0
   - Combat ends
   - Future: Replace 'manual' with 'death' reason

**Pause Flow:**

```typescript
// 1. Telegraph reveals â†’ Pause triggered
checkAutoPause(fighter, 'new_telegraph', telegraph);
// Sets pauseState.isPaused = true
// Sets pauseState.availableActions = opponent.availableSkills

// 2. Opponent selects skill
executeSkill(opponentId, skillId);
// Checks if skillId is in availableActions
// Creates action if allowed

// 3. Auto-unpause
// Game resumes immediately after valid action
pauseState.isPaused = false;
```

**Permission Check:**

```typescript
// GameEngine.ts:757-764
if (this.pauseState.isPaused) {
  const canThisFighterAct = this.pauseState.availableActions.includes(skillId);
  if (!canThisFighterAct) {
    console.warn(`Game is paused - ${fighter.name} cannot act right now`);
    return;
  }
}
```

**Auto-Unpause:**

```typescript
// GameEngine.ts:865-872
if (this.pauseState.isPaused) {
  this.pauseState.isPaused = false;
  this.pauseState.reason = null;
  this.pauseState.availableActions = [];
  this.pauseState.prediction = null;
  this.log('Combat resumed');
}
```

**Implementation:** `GameEngine.ts` (lines 687-728 checkAutoPause, 757-764 permission check, 865-872 auto-unpause)

### 3. **Combat Log Filtering**

**View Mode Rules:**

- **PC view:** Shows PC actions and "is ready to act again" messages for both
- **NPC view:** Shows NPC actions and "is ready to act again" messages for both
- **Debug view:** Shows everything

**Priority Filter:**

```typescript
// CombatScene.tsx:109-112
// Show "ready to act again" messages for ALL fighters (always visible)
if (entry.includes('is ready to act again')) {
  return true;
}
```

This filter runs **before** opponent hiding rules, ensuring recovery complete messages always show.

**Implementation:** `CombatScene.tsx` (lines 95-145)

### 4. **HP-Based Damage System (EXISTING)**

**Current System:**

- Both PC and NPC: **3 HP**
- All attacks: **3 base damage**
- Death condition: **HP <= 0**

**Damage Formula:**

```typescript
finalDamage = attackDamage * (1 - damageReductionPercent) - damageReductionFlat;
if (finalDamage < 0) finalDamage = 0;
```

**Defense Damage Reduction:**

- Emergency Defense: 2 flat â†’ 1 damage taken (3 - 2 = 1)
- Retreat: 100% reduction â†’ 0 damage (full dodge)
- Parry: 3 flat â†’ 0 damage (3 - 3 = 0)
- Deflection: 3 flat â†’ 0 damage (3 - 3 = 0)

**Implementation:** `GameEngine.ts:524-598` (resolveImpact method)

### 5. **50ms Tick Interval (EXISTING)**

**Atomic tick is 50ms**, not 100ms (changed from 100ms for better precision).

**Delayed Start:**

Combat timer doesn't start until first action is taken.

1. `GameEngine.start()` sets `isRunning = true` but doesn't start interval
2. Game is in "ready" state
3. When either PC or NPC calls `executeSkill()`, 50ms tick interval starts
4. Combat timing begins immediately

**Implementation:** `GameEngine.ts:211-225 start(), 874-884 executeSkill()`

### 6. **CSV Build System (EXISTING)**

**All combat skills come from CSV files.** JSON files are generated artifacts.

**Workflow:**

1. Edit CSV file (skills as columns for easy comparison)
2. Run `npm run build:skills`
3. Build script generates JSON with auto-calculated values
4. Game engine loads JSON at runtime

**Build script features:**

- Auto-calculates `impact_tick = windUp + committed`
- Auto-generates `type`, `school`, `stage` numbers
- Dynamically detects telegraph stages (t1, t2, ..., t99+)
- Validates timing values (errors on mismatch)
- Validates impact tick alignment with 50ms interval

**File:** `scripts/buildSkills.cjs` (heavily commented, ~580 lines)

### 7. **Fighter Names**

**PC:** "Mizhael"
**NPC:** "Bandit"

This was changed in the GameEngine constructor:

```typescript
// GameEngine.ts:66-67
this.pc = this.createFighter("pc", "Mizhael");
this.npc = this.createFighter("npc", "Bandit");
```

### 8. **React Portal Pattern for Modals**

**All modals MUST use React Portals** to escape parent stacking contexts.

```typescript
import { createPortal } from 'react-dom';

export function MyModal({ isOpen, onClose }: Props) {
  if (!isOpen) return null;

  const modalContent = (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]" onClick={onClose}>
      <div className="bg-gray-800 rounded-lg p-6 max-w-md w-full" onClick={(e) => e.stopPropagation()}>
        {/* Modal content */}
      </div>
    </div>
  );

  return createPortal(modalContent, document.body);
}
```

**Why:** Ensures modals appear above ALL UI elements regardless of parent z-index.

**Used in:** `LineSelectionModal.tsx`, `AttackPredictionDropdown.tsx`, `FeintSelectionModal.tsx`

### 9. **Tailwind Warning**

**DON'T use template literals for dynamic classes!**

```typescript
// WRONG - purged at build time
className={`text-${color}-400`}

// RIGHT - conditional expressions
className={fighter === 'pc' ? 'text-green-400' : 'text-red-400'}
```

### 10. **Git Commits from Today**

**4 commits made:**

1. **`517834302`** - "updated handover docs"
2. **`c7abb501a`** - "Implement timeline visualization with film strip behavior"
   - Complete timeline system
   - ActionHistoryEntry type
   - 5 timebars with phase colors
   - Configuration constants
3. **`e6ed6200`** - "Add recovery complete pause and declutter timeline views"
   - Recovery pause implementation
   - View mode filtering (PC/NPC/Debug)
   - Combat log filtering fix
   - Dynamic layout calculations
4. **`ffc089f3e`** - "Fix telegraph pause system to correctly identify opponent"
   - Telegraph pause logic fix
   - All telegraphs with pause=true trigger
   - Opponent correctly identified
5. **`b74dad982`** - "Fix pause system: Add permission checks and auto-unpause"
   - Pause permission check in executeSkill()
   - Auto-unpause after valid action
   - Complete pause flow working

---

## ğŸ—ï¸ Architecture Patterns

### Timeline Film Strip Flow:

```
GameEngine tracks actions
  â†“
actionHistory[] grows
  â†“
React re-renders TimelinePanel
  â†“
Calculate timelineOffsetPx = -(currentTick * pxPerMs) + nowPositionPx
  â†“
Apply CSS transform: translateX(timelineOffsetPx)
  â†“
Content moves left, "now" line stays fixed
```

### Pause System Flow:

```
Telegraph reveals (elapsed >= triggerTime)
  â†“
checkAutoPause() if telegraph.pause === true
  â†“
pauseState.isPaused = true
pauseState.availableActions = opponent.availableSkills
  â†“
UI shows pause state
  â†“
User selects skill
  â†“
executeSkill() checks permission
  â†“
If valid: create action + unpause
If invalid: reject with warning
```

### Event-Driven Game Loop:

```
GameEngine (pure TypeScript, no React)
  â†“ emits events every tick
React Components
  â†“ re-render
UI updates
```

**Key insight:** Engine has zero React dependencies. UI is just a listener.

### Atomic Tick Loop:

```typescript
// GameEngine.ts:258-282
private tick(): void {
  if (this.pauseState.isPaused) return;

  this.currentTick += this.tickInterval; // Advance time by 50ms

  this.updateFighter(this.pc);
  this.updateFighter(this.npc);

  this.emitStateUpdate(); // â†’ React
}
```

Everything happens in 50ms increments. Deterministic, no RNG.

---

## ğŸ”§ Current Skill Inventory

### âœ… Implemented Skills (10 total):

**Attacks (5):**

1. `overhead_strike` - Vertical overhead, high line, 600ms windUp, 1800ms total
2. `side_slash` - Horizontal slash, horizontal line, 500ms windUp, 2100ms total
3. `thrust` - Forward stab, center line, 250ms windUp, 1550ms total (fastest)
4. `upward_strike` - Rising attack, low line, 400ms windUp, 2000ms total
5. `diagonal_slash` - Angled cut, diagonal line, 600ms windUp, 2500ms total (slowest)

**Defenses (4):**

1. `emergency_defense` - Last resort, 100ms windUp, 2 flat reduction, 500ms recovery
2. `retreat` - Movement, 200ms windUp, 100% reduction (full dodge), 300ms recovery
3. `parry` - Line-based block, 300ms windUp, 3 flat reduction, requires correct line, 200ms recovery
4. `deflection` - Attack prediction block, 300ms windUp, 3 flat reduction, requires attack ID, 200ms recovery

**Special (1):**

1. `feint` - Attack morph, reads defender telegraph, 100ms penalty, 1.4x stamina cost

**All attacks deal 3 base damage. Most skills have multi-stage telegraphs.**

---

## ğŸ› Past Issues Solved (Don't Repeat)

1. **Tailwind CSS v4 incompatibility** - Locked to v3.4.17, never upgrade
2. **Duration vs Tick for impact** - Tick won (absolute time, not duration)
3. **Thrust not doing damage** - Fixed by changing tick interval to 50ms
4. **Timeline viewport overflow** - Fixed with CSS transform approach (no scrolling)
5. **Wrong telegraph pause logic** - Only paused for NPC telegraphs, fixed to pause for ALL telegraphs with pause=true
6. **Missing unpause logic** - Game stayed paused after action, fixed with auto-unpause
7. **Combat log filtering** - "is ready to act again" was hidden for opponents, fixed with priority filter
8. **Dynamic class names in Tailwind** - Use conditionals, NOT template literals
9. **Modal z-index issues** - Fixed with React Portals
10. **Legacy clean hit system** - Completely removed

---

## ğŸ“‹ Lessons Learned (This Session)

### What Worked Well:

1. **Film strip approach** - CSS transform is clean, performant, no scroll issues
2. **View mode filtering** - Decluttering PC/NPC views improves focus
3. **Configuration constants** - Plain-English comments make timeline adjustable
4. **Pause permission checks** - Prevents wrong fighter from acting
5. **Auto-unpause** - Seamless flow after valid action

### What Didn't Work:

1. **Initial telegraph pause logic** - Only checking NPC telegraphs was wrong
   - **Fix:** Check ALL telegraphs with pause=true, identify opponent
2. **Missing unpause** - Game stayed frozen after action
   - **Fix:** Auto-unpause in executeSkill() after valid action
3. **Combat log filtering** - Recovery messages were hidden
   - **Fix:** Priority filter for "is ready to act again" messages

### Important Insights:

1. **Pause state needs active management** - Not just setting isPaused, but also clearing it
2. **availableActions is skill IDs** - Not fighter IDs, so check if skillId is in the array
3. **Telegraph pause opponent logic** - "The one that can act is the opponent" (not the telegraphing fighter)
4. **View mode filtering must be dynamic** - Calculate timebar positions based on visible bars
5. **Combat log needs perspective filtering** - What PC sees vs what NPC sees

---

## ğŸ¤ User Agreements & Decisions

### Decisions Made Today:

1. **Timeline approach: Film strip** (not auto-scroll)
   - User confirmed: "Film strip is better"
   - Fixed viewport, moving content via CSS transform

2. **View mode decluttering**
   - User: "I want to declutter the view. In PC view I want to see only PC actual timebar and NPC_seen_by_PC"
   - Implemented: PC view shows 2 bars, NPC view shows 2 bars, Debug shows all 5

3. **Recovery complete pause**
   - User: "I need you to implement a pause when the recovery phase ends"
   - Message: "{name} is ready to act again"
   - Visible in all views

4. **Telegraph pause logic**
   - User: "The one that can act in the pause caused by telegraph is the opponent"
   - Fixed: ALL telegraphs with pause=true trigger pause for opponent

5. **Three pause types**
   - Telegraph pause: Opponent can act
   - Recovery pause: That fighter can act
   - Death pause: Combat ends

### User Preferences:

- **Concise explanations** - User wants direct, accurate info
- **File references** - Include paths and line numbers
- **TypeScript clarity** - Explain types clearly (user learning TS)
- **No unsolicited docs** - Don't create docs unless asked
- **Git commits** - User says "git commit" when ready

---

## ğŸ“– What Was Worked On (PR Summary)

### Timeline Visualization System

**Goal:** Implement scrollable timeline showing combat actions as phase-colored bars.

**Approach:** Film strip behavior with fixed viewport and moving content.

**Files Changed:**

1. **`src/types/CombatTypes.ts`**
   - Added `ActionHistoryEntry` interface (lines 195-211)
   - Added `actionHistory` to `GameState` (line 229)
   - Added `'recovery_complete'` to `PauseReason` (line 223)

2. **`src/engine/GameEngine.ts`** (~890 lines)
   - Added `actionHistory: ActionHistoryEntry[]` (line 95)
   - Added `createHistoryEntry()` helper (lines 438-484)
   - Track completed actions in attack/defense completion (lines 348-360, 406-420)
   - Clear history on stop (line 244)
   - Return history in getState() (line 1057)
   - Implement recovery complete pause (lines 352-357, 409-414)
   - Fix telegraph pause logic (lines 687-728)
   - Add pause permission check (lines 757-764)
   - Add auto-unpause (lines 865-872)

3. **`src/components/Timeline/TimelinePanel.tsx`** (complete rewrite, 501 lines)
   - Configuration constants (lines 22-82)
   - Film strip calculations (lines 127-150)
   - View mode filtering (lines 174-179)
   - Dynamic layout (lines 181-213)
   - Helper functions (lines 360-500)

4. **`src/components/CombatScene.tsx`**
   - Add combat log filtering (lines 95-145)
   - Priority filter for recovery messages (lines 109-112)

5. **`Timelines-design.md`** (new file)
   - Design specification for timeline system
   - Phase mechanics
   - Pause triggers
   - Timeline types

6. **`20251112_Timelines-implementation.md`** (new file)
   - Implementation guide
   - Configuration reference
   - Data structures
   - Future extensions

**Key Features Delivered:**

- âœ… Film strip timeline with 5 synchronized timebars
- âœ… Phase-colored action bars (green/yellow/grey/red)
- âœ… Action history tracking with pre-calculated phase timestamps
- âœ… View mode filtering (PC/NPC/Debug perspectives)
- âœ… Dynamic layout based on visible timebars
- âœ… Configuration constants with plain-English comments
- âœ… Recovery complete pause with log message
- âœ… Telegraph pause with opponent identification
- âœ… Pause permission checks
- âœ… Auto-unpause after valid action
- âœ… Combat log perspective filtering

**Testing:**

- Verified film strip movement matches tick interval
- Tested all three pause types (telegraph, recovery, death)
- Verified pause permission blocking wrong fighter
- Confirmed auto-unpause after valid action
- Tested view mode filtering in all 3 modes
- Verified combat log shows correct messages per view

---

## ğŸ¯ Next Steps

### Features Waiting for Implementation (With Plan):

1. **Hover Preview for Skills** âš¡ **HIGH PRIORITY**
   - **Status:** Not implemented
   - **Plan:**
     - Location: `TimelinePanel.tsx` (not ActionPanel)
     - Add `hoveredSkill` prop from ActionPanel
     - Use same `renderActionBars()` function with `opacity: 0.5`
     - Position preview at currentTick or after current action ends
     - Remove preview on hover end
   - **Why:** Lets player visualize "what if I select this skill?" before committing
   - **User comment:** "I think it is better to have it located in the TimelinePanel"

2. **Improve Death Pause**
   - **Status:** Uses 'manual' placeholder
   - **Plan:**
     - Add 'death' to PauseReason type
     - Update checkDeath() to use 'death' reason
     - Add death-specific UI feedback
   - **Why:** Clearer pause reason, better debugging

### Features Waiting for Implementation (Without Plan):

3. **Telegraph Markers on Timeline** ğŸ”µ **LOW PRIORITY**
   - **Status:** Not implemented
   - **Description:** Show visual markers at telegraph trigger times
   - **Notes:**
     - Add colored markers/icons at calculated X positions
     - Show telegraph stage numbers
     - Hover to see telegraph description
   - **User comment:** "Low priority"

4. **Prediction/Uncertainty Visualization** ğŸ”µ **LOW PRIORITY**
   - **Status:** Blocked - requires PredictionEngine
   - **Description:** Show min/max time ranges for opponent predicted timebars
   - **Current behavior:** Predicted timebars show actual opponent data
   - **Future behavior:** Show gradient between min/max times based on visible telegraphs
   - **User comment:** "Has dependency on PredictionEngine that is yet to be defined and built. UI is low priority now"

5. **True Perspective Filtering** ğŸ”µ **LOW PRIORITY**
   - **Status:** Blocked - requires PredictionEngine
   - **Description:** View mode should show perspective-appropriate data
   - **Current behavior:** All timebars show actual data
   - **Future behavior:**
     - PC mode: Show actual PC + predicted NPC (based on telegraphs PC can see)
     - NPC mode: Show actual NPC + predicted PC (based on telegraphs NPC can see)
   - **User comment:** "Has dependency on PredictionEngine that is yet to be defined and built. UI is low priority now"

6. **Expiring Choice Warnings** ğŸ”µ **LOW PRIORITY**
   - **Status:** Not implemented
   - **Description:** Auto-pause when decision window about to expire
   - **User comment:** "Low priority"

7. **Interactive Zoom Controls**
   - **Status:** Not needed yet
   - **Description:** Add buttons to adjust ZOOM_MS dynamically
   - **User comment:** "Zoom in the code is fine for now"

8. **Timeline Replay**
   - Ability to pause/resume combat
   - Scrub timeline to review specific moments
   - Playback speed controls

9. **Export Combat Recording**
   - Save actionHistory to JSON
   - Load and replay saved combats

### Started Tasks That Need to Be Finished:

**None.** All features from today's session are complete and working.

---

## ğŸ” Quick Reference

### File Locations:

**Engine:** `src/engine/GameEngine.ts` (~890 lines)
**Types:** `src/types/CombatTypes.ts` (all interfaces)
**Timeline:** `src/components/Timeline/TimelinePanel.tsx` (~501 lines)
**Build script:** `scripts/buildSkills.cjs` (~580 lines, heavily commented)
**React entry:** `src/components/CombatScene.tsx` (3-column layout, combat log)
**Action panel:** `src/components/Actions/ActionPanel.tsx` (accepts `fighter` prop)

### Key Functions:

**Main loop:** `GameEngine.tick()` - runs every 50ms (when started)
**Phase update:** `GameEngine.updatePhaseProgression()` - checks elapsed time
**Impact resolution:** `GameEngine.resolveImpact()` - applies damage formula
**History entry:** `GameEngine.createHistoryEntry()` - converts action to history
**Pause check:** `GameEngine.checkAutoPause()` - telegraph pause logic
**Skill execution:** `GameEngine.executeSkill()` - permission check + auto-unpause
**Timeline render:** `TimelinePanel.renderActionBars()` - phase-colored bars

### Build Commands:

```bash
npm run dev              # Start dev server
npm run build:skills     # Rebuild all skills from CSV
npm run validate:skills  # Validate CSV without writing
```

### Timeline Configuration:

**Location:** `TimelinePanel.tsx` lines 22-82

```typescript
PAST_MS: 1000,              // 1s history visible
ZOOM_MS: 3000,              // 3s total visible
MIN_PX_PER_MS: 0.1,         // Max zoom out
MAX_PX_PER_MS: 1.0,         // Max zoom in
TIMEBAR_HEIGHT: 30,         // Bar height
TIMEBAR_SPACING: 8,         // Gap between bars
NOW_LINE_WIDTH: 2,          // "Now" line width
```

### Timing Reference:

**Tick rate:** 50ms (20 ticks per second)
**Fastest attack:** thrust (250ms windUp, 850ms impact, 1550ms total)
**Slowest attack:** diagonal_slash (600ms windUp, 1900ms impact, 2500ms total)
**Emergency defense:** 100ms windUp (last resort timing)
**Parry/Deflection recovery:** 200ms (shortest, enables riposte)

### Damage Reference:

**HP:** 3 for both PC and NPC
**Base damage:** 3 for all attacks
**Death:** HP <= 0
**Formula:** `finalDamage = attackDamage * (1 - damageReductionPercent) - damageReductionFlat`

**Defense reductions:**
- Emergency Defense: 2 flat â†’ 1 damage taken
- Retreat: 100% reduction â†’ 0 damage
- Parry: 3 flat â†’ 0 damage
- Deflection: 3 flat â†’ 0 damage

### Pause Reference:

**Three pause types:**
1. Telegraph pause (`new_telegraph`) - Opponent can act
2. Recovery pause (`recovery_complete`) - That fighter can act
3. Death pause (`manual`) - Combat ends

**Pause flow:**
- Telegraph reveals â†’ checkAutoPause() â†’ isPaused = true
- User selects skill â†’ executeSkill() checks permission
- If valid â†’ create action + auto-unpause

---

## ğŸ’¡ Working With This User

**Communication style:**

- Prefers concise, accurate explanations
- Will edit CSV/code files directly
- Likes seeing options/trade-offs before choosing
- Values technical accuracy over validation
- Learning TypeScript, appreciates clear type explanations

**When explaining code:**

- Show file path with line numbers: `GameEngine.ts:757-764`
- Explain TypeScript types clearly
- Reference design docs by name
- Use examples from actual codebase
- Mention if reading docs would help

**Red flags (DON'T do this):**

- âŒ Don't create documentation files unprompted
- âŒ Don't refactor unless asked
- âŒ Don't add emojis unless requested
- âŒ Don't guess at URLs
- âŒ Don't update git without being asked

**User instructions from CLAUDE.md:**

1. Double-check things, be skeptical, do research
2. User is not always right (neither are you)
3. Stick to React best practices (avoid unnecessary effects)

---

## ğŸ¤ Good Luck!

The codebase is clean, well-commented, and working. The timeline system provides excellent visual feedback. The pause system correctly handles all three pause types. The CSV build system makes skill iteration fast. The user is engaged and gives clear feedback.

**Start here:**

1. Read `CLAUDE.md` - User instructions
2. Read `Timelines-design.md` - Timeline mechanics
3. Read `20251112_Timelines-implementation.md` - Implementation guide
4. Read `CombatTypes.ts` - Understand data model (especially ActionHistoryEntry)
5. Read `GameEngine.ts` - Focus on pause system and action history
6. Read `TimelinePanel.tsx` - Film strip implementation

**Most important changes today:**

- Timeline visualization with film strip behavior
- Action history tracking with pre-calculated phase times
- View mode filtering (PC/NPC/Debug)
- Recovery complete pause
- Telegraph pause fix (opponent identification)
- Pause permission checks
- Auto-unpause after valid action
- Combat log perspective filtering

**When in doubt:**

- Check `Timelines-design.md` for design decisions
- Check `20251112_Timelines-implementation.md` for implementation details
- Look at `TIMELINE_CONFIG` constants in TimelinePanel.tsx
- Check git log for today's commits: `git log --since="2025-11-12 00:00:00"`
- Test in the running prototype (npm run dev)
- Read the code comments (they're detailed)

**High priority next feature:** Hover preview for skills (see Next Steps section)
